name: Automate release

on:
  workflow_dispatch:
    inputs:
      short-description:
        description: |
          A brief summary of what the release contains.
          This will be added directly to the release ticket.
        required: true
      rule-props-changed:
        type: choice
        description: |
          Did any rule properties change in this release?
        required: true
        default: "No"
        options:
          - "Yes"
          - "No"
      sq-compatibility:
        description: |
          SonarQube compatibility.
          Default needs to be changed only in case of LTA fix release.
        default: ">=10.8"
        required: true
      branch:
        description: |
          Branch from which to do the release.
        required: true
        default: "master"
      release_notes:
        description: |
          Github release notes.
          If blank, release notes will be generated from the Jira Release.
      new-version:
        description: |
          Specify the version for the next release (e.g., 4.2.0).
          If left blank, the minor version will be automatically incremented.

jobs:
  lock-branch:
    name: Lock ${{ inputs.branch }} branch
    uses: ./.github/workflows/ToggleLockBranch.yml
    permissions:
      id-token: write
    with:
      branch: ${{ inputs.branch }}

  release:
    name: Release
    uses: SonarSource/release-github-actions/.github/workflows/cloud-security-automated-release.yml@yp/add_cloud_security_workflow
    needs: lock-branch
    permissions:
      statuses: read
      id-token: write
      contents: write
      actions: write
      pull-requests: write
    with:
      jira-project-key: "SONARPHP"
      project-name: "SonarPHP"
      plugin-name: "php"
      plugin-artifacts: "php"
      use-jira-sandbox: true
      is-draft-release: true
      pm-email: "yasen.pavlov@sonarsource.com"
      release-automation-secret-name: "sonar-php-release-automation"
      short-description: ${{ inputs.short-description }}
      rule-props-changed: ${{ inputs.rule-props-changed }}
      sq-compatibility: ${{ inputs.sq-compatibility }}
      branch: ${{ inputs.branch }}
      release_notes: ${{ inputs.release-notes }}
      new-version: ${{ inputs.new-version }}

  unlock-branch:
    name: Unlock ${{ inputs.branch }} branch
    uses: ./.github/workflows/ToggleLockBranch.yml
    needs: release
    permissions:
      id-token: write
    with:
      branch: ${{ inputs.branch }}

  bump_versions:
    name: Bump versions
    needs: unlock-branch
    uses: ./.github/workflows/bump-versions.yaml
    permissions:
      contents: write
      pull-requests: write
    with:
      version: ${{ needs.release.outputs.new-version }}-SNAPSHOT
