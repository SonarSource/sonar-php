name: Automate release

env:
  PROJECT_KEY: 'SONARPHP'
  PROJECT_NAME: 'SonarPHP'

permissions:
  checks: read

on:
  workflow_dispatch:
    inputs:
      short_description:
        description: 'Short Description'
        required: true
      next_version:
        description: 'Next version to create after release (if not provided the currently released version will be incremented)'
        required: false
      jira_release_name:
        description: 'Jira release version (if not provided and there is only one unreleased release in jira for this project it will be used instead'
        required: false
      sonarlint_changelog:
        description: 'SonarLint changelog content'
        required: false

jobs:
  check_releasability:
    name: Check releasability
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.check_releasability_status.outputs.version }}
    steps:
      - name: Check Releasability and Get Version
        id: check_releasability_status
        uses: SonarSource/release-github-actions/check-releasability-status@master

  create_release_ticket:
    name: Create release ticket
    runs-on: ubuntu-latest
    needs: check_releasability
    permissions:
      contents: read
      id-token: write # Required for authenticating to Vault
    outputs:
      jira_release_name: ${{ steps.create_ticket.outputs.jira_release_name }}
    steps:
      - name: Get Jira Credentials from Vault
        id: secrets
        uses: SonarSource/vault-action-wrapper@v3
        with:
          secrets: |
            development/kv/data/jira user | JIRA_USER;
            development/kv/data/jira token | JIRA_TOKEN;

      - name: Create Jira Release Ticket
        id: create_ticket
        uses: SonarSource/release-github-actions/create-jira-release-ticket@revert_remove_targeted_product
        with:
          jira_user: ${{ fromJSON(steps.secrets.outputs.vault).JIRA_USER }}
          jira_token: ${{ fromJSON(steps.secrets.outputs.vault).JIRA_TOKEN }}
          project_key: ${{ env.PROJECT_KEY }}
          project_name: ${{ env.PROJECT_NAME }}
          version: ${{ needs.check_releasability.outputs.version }}
          short_description: ${{ github.event.inputs.short_description }}
          sq_compatibility: ">=LTS"
          jira_release_name: ${{ github.event.inputs.jira_release_name }}
          sonarlint_changelog: ${{ github.event.inputs.sonarlint_changelog }}
#
#      - name: Start progress on release ticket
#        id: rel_ticket_start_progress
#        uses: SonarSource/release-github-actions/update-release-ticket-status/@master
#        with:
#          jira_user: ${{ fromJSON(steps.secrets.outputs.vault).JIRA_USER }}
#          jira_token: ${{ fromJSON(steps.secrets.outputs.vault).JIRA_TOKEN }}
#          ticket_key: ${{ steps.create_ticket.outputs.ticket_key }}
#          status: "Start Progress"
#
#  publish_release:
#    name: Publish Release
#    runs-on: ubuntu-latest
#    needs: [check_releasability, create_release_ticket]
#    permissions:
#      contents: write
#      id-token: write # Required for authenticating to Vault
#    steps:
#      - name: Get Jira Credentials from Vault
#        id: secrets
#        uses: SonarSource/vault-action-wrapper@v3
#        with:
#          secrets: |
#            development/kv/data/jira user | JIRA_USER;
#            development/kv/data/jira token | JIRA_TOKEN;
#
#      - name: Publish Github release
#        id: publish_github_release
#        uses: SonarSource/release-github-actions/publish-github-release@SONARIAC-2094
#        with:
#          version: ${{ needs.check_releasability.outputs.version }}
#          jira_project_key: ${{ env.PROJECT_KEY }}
#          jira_release_name: ${{ needs.create_release_ticket.outputs.jira_release_name }}
#          jira_user: ${{ fromJSON(steps.secrets.outputs.vault).JIRA_USER }}
#          jira_token: ${{ fromJSON(steps.secrets.outputs.vault).JIRA_TOKEN }}
#
#      - name: Release in Jira and Create Next Version
#        id: jira_release
#        uses: SonarSource/release-github-actions/release-jira-version@SONARIAC-2095
#        with:
#          jira_user: ${{ fromJSON(steps.secrets.outputs.vault).JIRA_USER }}
#          jira_token: ${{ fromJSON(steps.secrets.outputs.vault).JIRA_TOKEN }}
#          project_key: ${{ env.PROJECT_KEY }}
#          jira_release_name: ${{ needs.create_release_ticket.outputs.jira_release_name }}
#          new_version_name: ${{ github.event.inputs.next_version }}
